{% extends 'event/partials/_event_layout.html.twig' %}

{% block title %}Photos souvenirs de la LAN
	{{ event.name }}
{% endblock %}

{% block event_layout %}
	<div class="flex items-center justify-center gap-4 mb-12">
		<h2 class="text-3xl font-bold text-neonBlue">Photos souvenirs</h2>
		<a href="{{ path('event_photo_add', { event: event.id }) }}" class="btn-primary px-3 py-1">➕</a>
	</div>

	<div x-data="{ activePhoto: null }">
		<div class="flex flex-wrap justify-center mt-12 text-white gap-8">
			{% for photo in photos %}
				<div
					class="relative rounded-xl overflow-hidden shadow-lg cursor-pointer flex flex-col items-center justify-start bg-gray-900 transition-all duration-700 ease-in-out" x-show="!activePhoto || activePhoto === {{ photo.id }}" :style="activePhoto === {{ photo.id }}
						    ? (window.innerWidth < 768 ? 'width: 100%; z-index: 20;' : 'width: 50%; z-index: 20;')
						    : 'width: 18rem; z-index: 0;'">

					<!-- Boutons -->
					<div class="absolute right-2 flex space-x-2 z-20 transition-all duration-300" :class="activePhoto === {{ photo.id }} ? 'top-2' : 'top-2'">

						{% if app.user and (app.user == photo.uploadedBy or app.user == event.organizer) %}
							<button type="button" data-modal-target="delete-photo-{{ photo.id }}" data-modal-toggle="delete-photo-{{ photo.id }}" class="btn-delete" x-show="activePhoto !== {{ photo.id }}">
								<i class="bi bi-trash"></i>
							</button>
						{% endif %}

						<button class="btn-edit" @click.stop="activePhoto = (activePhoto === {{ photo.id }} ? null : {{ photo.id }})" title="Étendre / réduire">
							<i :class="activePhoto === {{ photo.id }} ? 'bi bi-arrows-collapse text-xl' : 'bi bi-arrows-fullscreen'"></i>
						</button>

						{% if app.user and app.user == event.organizer and not photo.isApproved %}
							<button type="button" data-modal-target="approve-photo-{{ photo.id }}" data-modal-toggle="approve-photo-{{ photo.id }}" class="btn-view" x-show="activePhoto !== {{ photo.id }}">
								<i class="bi bi-check-lg"></i>
							</button>
						{% endif %}
					</div>


					<!-- Image -->
					<img
					src="{{ asset('uploads/eventImages/' ~ photo.imageName) }}" alt="Photo de la LAN {{ event.name }}" class="w-full object-cover rounded-t-xl transition-all duration-700 ease-in-out" :style="activePhoto === {{ photo.id }} ? 'height: 32rem;' : 'height: 16rem;'">

					<!-- Contenu -->
					<div class="bg-gray-800 w-full transition-all duration-500" :class="activePhoto === {{ photo.id }} ? 'p-6' : 'p-4'">

						<p class="text-sm text-gray-400" x-show="activePhoto !== {{ photo.id }}">
							Ajoutée le
							{{ photo.createdAt|date('d/m/Y') }}
							par
							{% if photo.uploadedBy and photo.uploadedBy.profile and photo.uploadedBy.profile.nickname %}
								{{ photo.uploadedBy.profile.nickname }}
							{% else %}
								Anonyme
							{% endif %}
						</p>

						{% if photo.caption %}
							<p class="text-gray-200 mt-1" x-show="activePhoto !== {{ photo.id }}">{{ photo.caption }}</p>
						{% endif %}

						<div x-show="activePhoto === {{ photo.id }}" class="mt-4 " x-ref="comments{{ photo.id }}">

							<h3 class="text-lg font-semibold mb-3 text-neonBlue">Commentaires</h3>

							<div class="relative space-y-2 h-48 overflow-y-auto pr-2 custom-scrollbar">
								{% for comment in photo.commentaries %}
									<div class="bg-gray-700/50 p-2 rounded-lg">
										<p class="text-sm text-gray-200">
											<strong class="text-neonBlue">@{{ comment.author.profile.nickname ?: 'Anonyme' }}</strong>
											:
											{{ comment.content }}
										</p>
									</div>
								{% else %}
									<p class="text-gray-500 text-sm italic">Aucun commentaire pour le moment.</p>
								{% endfor %}
							</div>

							<!-- Formulaire -->
							<div class="mt-4 flex gap-3">
								{{ form_start(commentForms[photo.id], {'attr': {'class': 'flex w-full gap-3'}}) }}
								{{ form_widget(commentForms[photo.id].content, {
										'attr': {
											'id': 'comment_content_' ~ photo.id,
											'class': 'flex-1 bg-gray-800/80 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-neonBlue focus:outline-none',
											'placeholder': 'Écrire un commentaire...',
											'x-ref': 'input' ~ photo.id,
											'x-effect': "if (activePhoto === " ~ photo.id ~ ") { $nextTick(() => $refs['input" ~ photo.id ~ "'].scrollIntoView({behavior: 'smooth', block: 'center'})); }"
										}
									}) }}
								<button type="submit" class="btn-primary px-3 py-2 text-sm">Envoyer</button>
								{{ form_end(commentForms[photo.id]) }}
							</div>
						</div>
					</div>
				</div>
			{% else %}
				<p class="w-full text-center text-gray-400">Aucune photo disponible pour le moment.</p>
			{% endfor %}
		</div>
	</div>

	<div class="flex justify-center mt-12">
		<a href="{{ path('event_photo_add', {event: event.id}) }}" class="btn-primary px-3 py-1 text-base hover:scale-105 transform shadow-xl transition-all duration-300 ease-in-out">
			➕ Ajouter une photo
		</a>
	</div>
{% endblock %}

{% block modals %}
	{% for photo in photos %}
		{% if app.user and (app.user == photo.uploadedBy or app.user == event.organizer) %}
			{% include 'event/photos/partials/_delete_photo_modal.html.twig' with { photo: photo } %}
			{% include 'event/photos/partials/_approve_photo_modal.html.twig' with { photo: photo } %}
		{% endif %}
	{% endfor %}
{% endblock %}
