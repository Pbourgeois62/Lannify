{% extends 'event/partials/_event_layout.html.twig' %}

{% block title %}
    {{ event.name }}
{% endblock %}

{% block event_layout %}
<div class="flex items-center justify-center gap-4 px-4 mb-12">
    <h2 class="text-3xl font-bold text-neonBlue">Besoins pour la LAN</h2>
    <a href="{{ path('need_create', { event: event.id }) }}" 
       class="btn-primary px-3 py-1 text-base hover:scale-105 transform shadow-xl transition-all duration-300">
        ➕
    </a>
</div>

{% if event.needs is not empty %}
<div class="w-full px-4 space-y-4">
    {% for need in event.needs %}
        {% set provided = need.quantity - need.getRemainingQuantity() %}
        {% set ratio = provided / need.quantity %}
        {% set badgeClass = ratio == 0 ? 'badge-warning' : (ratio < 1 ? 'badge-fun2' : 'badge-success') %}

        <div 
            x-data="{ open: false }" 
            class="bg-darkGrey border border-neonBlue rounded-xl shadow-lg transition-all duration-300 hover:shadow-neonBlue/50 overflow-hidden"
            :class="open ? 'shadow-neonBlue/70 scale-[1.01]' : ''"
        >
            {# --- En-tête cliquable --- #}
            <div class="flex justify-between items-center p-4 cursor-pointer select-none" @click="open = !open">
                <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4 flex-1">
                    <span class="text-lg font-bold text-neonBlue max-w-3xl">{{ need.label }}</span>
                    <span class="text-sm text-gray-400 flex items-center gap-2 mt-1 sm:mt-0">
                        {% set avatar = need.createdBy.profile.avatar.imageName ?? 'default-avatar.webp' %}
                        <img src="{{ asset(avatar starts with 'default' ? 'images/' ~ avatar : 'uploads/events/' ~ avatar) }}"
                             alt="Avatar"
                             class="w-6 h-6 rounded-full object-cover">
                        Proposé par
                        <span class="text-neonBlue">{{ need.createdBy.profile.nickname ?? need.createdBy.email }}</span>
                    </span>
                </div>

                <div class="flex items-center gap-3 ml-4">
                    <span class="{{ badgeClass }}">{{ provided }}/{{ need.quantity }}</span>

                    {% if app.user and ((event.organizer and app.user.id == event.organizer.id) or (need.createdBy and app.user.id == need.createdBy.id)) %}
                        <a href="{{ path('need_edit', {need: need.id, event: event.id}) }}" class="btn-edit" title="Modifier">
                            <i class="bi bi-pencil-square text-xl"></i>
                        </a>
                        <button type="button"
                                data-modal-target="delete-need-{{ need.id }}"
                                data-modal-toggle="delete-need-{{ need.id }}"
                                class="btn-delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    {% endif %}

                    {# --- Flèche dynamique : on utilise :style pour la transform (robuste face à la purge Tailwind) --- #}
                    <i
                      class="bi bi-chevron-down text-xl text-neonBlue transition-transform duration-300 ease-in-out inline-block"
                      :style="open ? 'transform: rotate(180deg) translateY(4px);' : 'transform: rotate(0deg) translateY(0);'"></i>
                </div>
            </div>

            {# --- Contenu dépliable --- #}
            <div x-show="open"
                 x-transition:enter="transition-all ease-out duration-300"
                 x-transition:enter-start="opacity-0 max-h-0"
                 x-transition:enter-end="opacity-100 max-h-screen"
                 x-transition:leave="transition-all ease-in duration-300"
                 x-transition:leave-start="opacity-100 max-h-screen"
                 x-transition:leave-end="opacity-0 max-h-0"
                 class="px-4 pb-4 space-y-4 border-t border-neonBlue bg-darkGrey/80"
            >

                {# Contributions existantes #}
                <div class="space-y-2 mt-4">
                    {% for contribution in need.contributions %}
                        {% set avatar = contribution.user.profile.avatar.imageName ?? 'default-avatar.webp' %}
                        <div class="flex items-center bg-darkGrey/60 rounded-lg">
                            <img src="{{ asset(avatar starts with 'default' ? 'images/' ~ avatar : 'uploads/events/' ~ avatar) }}"
                                 alt="Avatar {{ contribution.user.profile.nickname ?? contribution.user.email }}" 
                                 class="w-10 h-10 rounded-full object-cover">
                            <span class="text-sm text-gray-300">
                                {{ contribution.user.profile.nickname ?? contribution.user.email }} en apporte 
                            </span>
                            <span class="text-sm font-semibold text-neonBlue">{{ contribution.quantity }}</span>
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-400 italic">Personne n'a encore contribué.</p>
                    {% endfor %}
                </div>

                {# Formulaire de contribution #}
                <div class="pt-3 mb-4 border-t border-neonBlue">
                    <h4 class="text-base font-semibold text-electricPurple mb-2">Ma participation</h4>
                    {{ form_start(forms[need.id], { attr: { class: 'flex items-center gap-2' } }) }}
                        {{ form_widget(forms[need.id].quantity, { attr: { class: 'input w-24 text-center', placeholder: "J'apporte..." } }) }}
                        <button type="submit" class="btn-primary py-1 px-4">✔</button>
                    {{ form_end(forms[need.id]) }}
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% else %}
    <p class="text-gray-400 italic text-center">Aucun besoin ajouté pour le moment.</p>
{% endif %}

<div class="flex justify-center mt-12">
    <a href="{{ path('need_create', {event: event.id}) }}" 
       class="btn-primary px-3 py-1 text-base hover:scale-105 transform shadow-xl transition-all duration-300">
        ➕ Ajouter un besoin
    </a>
</div>
{% endblock %}

{% block modals %}
    {% for need in event.needs %}
        {% if app.user and ((event.organizer and app.user.id == event.organizer.id) or (need.createdBy and app.user.id == need.createdBy.id)) %}
            {% include 'event/needs/partials/_delete_need_modal.html.twig' with { need: need } %}
        {% endif %}
    {% endfor %}
{% endblock %}
