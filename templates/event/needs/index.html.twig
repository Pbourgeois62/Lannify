{% extends 'event/partials/_event_layout.html.twig' %}

{% block title %}
    {{ event.name }}
{% endblock %}

{% block event_layout %}

<div class="flex items-center justify-center gap-4 px-4 mb-6 mb-12">
    <h2 class="text-3xl font-bold text-neonBlue">Besoins pour la LAN</h2>
    <a href="{{ path('need_create', { event: event.id }) }}" 
       class="btn-primary px-3 py-1 text-base hover:scale-105 transform shadow-xl transition-all duration-300">
        ➕
    </a>
</div>

{% if event.needs is not empty %}
<div class="w-full px-4">
    <div id="accordion-needs" data-accordion="collapse">
        {% for need in event.needs %}
            <h2 class="mb-2" id="accordion-heading-{{ need.id }}">
    <div class="flex justify-between items-center w-full p-4 bg-darkGrey border border-neonBlue rounded-xl shadow-lg">
        
        {# Bouton qui ouvre/ferme l'accordéon #}
        <button type="button"
            class="flex-1 text-left font-medium text-neonBlue hover:shadow-neonBlue/50 transition-all duration-300"
            data-accordion-target="#accordion-body-{{ need.id }}"
            aria-expanded="false"
            aria-controls="accordion-body-{{ need.id }}">
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4">
                <span class="text-lg font-bold">{{ need.label }}</span>
                <span class="text-sm text-gray-400 flex items-center gap-2">
                    {% if need.createdBy.profile.avatar %}
                        <img src="{{ asset('uploads/events/' ~ need.createdBy.profile.avatar.imageName) }}"
                             alt="Avatar"
                             class="w-6 h-6 rounded-full object-cover">
                    {% else %}
                        <img src="{{ asset('images/default-avatar.png') }}"
                             alt="Avatar"
                             class="w-6 h-6 rounded-full object-cover">
                    {% endif %}
                    Proposé par
                    <span class="text-neonBlue">{{ need.createdBy.profile.nickname ?? need.createdBy.email }}</span>
                </span>
            </div>
        </button>

        {# ✅ Boutons d’action hors du toggle #}
        <div class="flex items-center gap-3 ml-4">
            {% set provided = need.quantity - need.getRemainingQuantity() %}
            {% set ratio = provided / need.quantity %}
            <span class="{%
                if ratio == 0 %}badge-warning
                {% elseif ratio < 1 %}badge-fun2
                {% else %}badge-success
            {% endif %}">
                {{ provided }}/{{ need.quantity }}
            </span>

            {% if app.user and ((event.organizer and app.user.id == event.organizer.id) or (need.createdBy and app.user.id == need.createdBy.id)) %}
                <a href="{{ path('need_edit', {need: need.id, event: event.id}) }}" class="btn-edit" title="Modifier">
                    <i class="bi bi-pencil-square text-xl"></i>
                </a>
                <button type="button"
                        data-modal-target="delete-need-{{ need.id }}"
                        data-modal-toggle="delete-need-{{ need.id }}"
                        class="btn-delete">
                    <i class="bi bi-trash"></i>
                </button>
            {% endif %}
        </div>
    </div>
</h2>


            <div id="accordion-body-{{ need.id }}" class="hidden transition-all duration-300" aria-labelledby="accordion-heading-{{ need.id }}">
                <div class="p-4 border-t border-neonBlue space-y-4 bg-darkGrey rounded-b-xl">
                    
                    {# Contributions #}
                    <div class="space-y-2">
                        {% for contribution in need.contributions %}
                            <div class="flex items-center gap-2 bg-darkGrey/60 p-2 rounded-lg">
                                {% if contribution.user.profile.avatar is defined %}
                                    <img src="{{ asset('uploads/events/' ~ contribution.user.profile.avatar.imageName) }}" 
                                         alt="Avatar {{ contribution.user.profile.nickname ?? contribution.user.email }}" 
                                         class="w-8 h-8 rounded-full object-cover">
                                {% else %}
                                    <img src="{{ asset('images/default-avatar.webp') }}" alt="Avatar" class="w-8 h-8 rounded-full object-cover">
                                {% endif %}
                                <span class="text-sm text-gray-300">
                                    {{ contribution.user.profile.nickname ?? contribution.user.email }} apporte 
                                </span>
                                <span class="text-sm font-semibold text-neonBlue">{{ contribution.quantity }}</span>
                            </div>
                        {% else %}
                            <p class="text-sm text-gray-400 italic">Personne n'a encore contribué.</p>
                        {% endfor %}
                    </div>

                    {# Formulaire contribution #}
                    <div class="pt-3 border-t border-neonBlue">
                        <h4 class="text-base font-semibold text-electricPurple mb-2">Ma participation</h4>
                        {{ form_start(forms[need.id], { attr: { class: 'flex items-center gap-2' } }) }}
                            {{ form_widget(forms[need.id].quantity, { attr: { class: 'input w-24 text-center', placeholder: "J'apporte..." } }) }}
                            <button type="submit" class="btn-primary py-1 px-4">✔</button>
                        {{ form_end(forms[need.id]) }}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% else %}
    <p class="text-gray-400 italic text-center">Aucun besoin ajouté pour le moment.</p>
{% endif %}
	<div class="flex justify-center mt-12">
		<a href="{{ path('need_create', {event: event.id}) }}" class="btn-primary px-3 py-1 text-base hover:scale-105 transform shadow-xl transition-all duration-300">
			➕ Ajouter un besoin
		</a>
	</div>
{% endblock %}

{% block modals %}
	{% for need in event.needs %}
        {% if app.user and ((event.organizer and app.user.id == event.organizer.id) or (need.createdBy and app.user.id == need.createdBy.id)) %}
			{% include 'event/needs/partials/_delete_need_modal.html.twig' with { need: need } %}
		{% endif %}
	{% endfor %}
{% endblock %}
