<div
    id="event-chat-container"
    data-controller="chat"
    data-chat-mercure-url-value="{{ mercureUrl }}"
    data-chat-user-id-value="{{ app.user.id }}"
    data-chat-post-url-value="{{ path('event_chat_post', { id: event.id }) }}"
    class="hidden fixed top-20 right-6 z-40 flex flex-col w-96 max-h-[500px] backdrop-blur-md bg-gray-900/95 border border-electricPurple rounded-xl shadow-2xl shadow-electricPurple overflow-hidden"
    data-chat-target="container"
>
    <!-- En-tête du chat -->
    <div class="flex items-center justify-center px-4 py-3 border-b border-gray-700 bg-gray-800/80">
        <h3 class="text-white font-semibold text-sm tracking-wide flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neonBlue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-4l-4 4z"/>
            </svg>
            Chat de l’événement
        </h3>
    </div>

    <!-- Messages existants -->
    <div id="event-chat" data-chat-target="messages" class="flex-1 flex flex-col space-y-3 px-4 py-3 overflow-y-auto custom-scrollbar">
        {% for message in messages %}
            {% set isUser = message.sender.id == app.user.id %}
            <div class="flex {{ isUser ? 'justify-end' : 'justify-start' }}">
                <div class="flex items-end gap-2 {{ isUser ? 'flex-row-reverse' : '' }}">
                    {% if message.sender.profile and message.sender.profile.avatar is not null %}
                        <img src="{{ asset('uploads/events/' ~ message.sender.profile.avatar.imageName) }}" alt="avatar" class="w-8 h-8 rounded-full shadow-sm shrink-0">
                    {% else %}
                        <img src="{{ asset('images/default-avatar.webp') }}" alt="avatar" class="w-8 h-8 rounded-full shadow-sm shrink-0">
                    {% endif %}
                    <div class="flex flex-col {{ isUser ? 'items-end' : 'items-start' }}">
                        <div class="relative px-4 py-2 rounded-2xl inline-block shadow-sm
                            {{ isUser
                                ? 'bg-gradient-to-br from-neonBlue/90 to-blue-600/80 text-darkGrey rounded-br-none self-end'
                                : 'bg-gray-700/80 text-white rounded-bl-none self-start' }}">
                            <p class="text-[13px] font-medium mb-0.5">
                                {{ isUser ? 'Vous' : message.sender.profile.nickname ?: message.sender.email }}
                            </p>
                            <p class="text-sm leading-relaxed whitespace-normal break-all">{{ message.content }}</p>
                        </div>
                        <span class="text-[10px] text-gray-400 mt-1">{{ message.createdAt|date('H:i') }}</span>
                    </div>
                </div>
            </div>
        {% else %}
            <p class="text-gray-400 text-center mt-4">Aucun message pour le moment.</p>
        {% endfor %}
    </div>

    <!-- Formulaire -->
    <form id="event-chat-form" data-chat-target="form" class="flex items-center gap-2 p-3 border-t border-gray-700 bg-gray-800/80">
        <textarea name="content" rows="1" placeholder="Écrivez un message..." class="input text-white text-sm focus:ring-2 focus:ring-neonBlue focus:border-neonBlue w-full rounded-xl p-2 bg-gray-900/90 border border-gray-600 resize-none"></textarea>
        <button type="submit" class="btn-primary text-sm px-4 py-2">Envoyer</button>
    </form>
</div>
